#!/bin/bash

echo "ðŸš€ CONFIGURAÃ‡ÃƒO COMPLETA DO VOXFUTURE PARA CODEMAGIC"

# ConfiguraÃ§Ãµes
APP_NAME="VOXFUTURE"
APP_ID="com.voxfuture.app"
PROJECT_DIR=$(pwd)

# Cores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${YELLOW}ðŸ“± Iniciando configuraÃ§Ã£o completa...${NC}"

# Verificar se Ã© projeto Flutter
if [ ! -f "pubspec.yaml" ]; then
    echo -e "${RED}âŒ ERRO: NÃ£o Ã© um projeto Flutter vÃ¡lido${NC}"
    echo "Execute este script na raiz do projeto Flutter"
    exit 1
fi

# 1. VERIFICAR ESTRUTURA ATUAL
echo -e "${YELLOW}ðŸ” Analisando estrutura atual...${NC}"
echo "ðŸ“ Estrutura atual:"
ls -la

# 2. REGERAR ESTRUTURA FLUTTER SE NECESSÃRIO
if [ ! -d "android" ] || [ ! -d "ios" ]; then
    echo -e "${YELLOW}ðŸ”„ Regenerando estrutura Android/iOS...${NC}"
    
    # Backup de arquivos importantes
    mkdir -p temp_backup
    [ -f "lib/main.dart" ] && cp lib/main.dart temp_backup/
    [ -f "pubspec.yaml" ] && cp pubspec.yaml temp_backup/
    [ -f "assets/" ] && cp -r assets/ temp_backup/ 2>/dev/null || true
    
    # Regenerar estrutura
    flutter create --org com.voxfuture --project-name voxfuture_app --platforms android,ios .
    
    # Restaurar arquivos
    [ -f "temp_backup/main.dart" ] && cp temp_backup/main.dart lib/
    [ -f "temp_backup/pubspec.yaml" ] && cp temp_backup/pubspec.yaml .
    [ -d "temp_backup/assets" ] && cp -r temp_backup/assets/ . 2>/dev/null || true
    
    rm -rf temp_backup
    echo -e "${GREEN}âœ… Estrutura regenerada${NC}"
else
    echo -e "${GREEN}âœ… Estrutura Android/iOS jÃ¡ existe${NC}"
fi

# 3. CONFIGURAR ANDROID
echo -e "${YELLOW}ðŸ¤– Configurando Android...${NC}"

# Atualizar build.gradle
cat > android/app/build.gradle << 'EOF'
def localProperties = new Properties()
def localPropertiesFile = rootProject.file('local.properties')
if (localPropertiesFile.exists()) {
    localPropertiesFile.withReader('UTF-8') { reader ->
        localProperties.load(reader)
    }
}

def flutterRoot = localProperties.getProperty('flutter.sdk')
if (flutterRoot == null) {
    throw new GradleException("Flutter SDK not found.")
}

apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'
apply from: "$flutterRoot/packages/flutter_tools/gradle/flutter.gradle"

android {
    namespace "com.voxfuture.app"
    compileSdkVersion 34
    ndkVersion "25.1.8937393"

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = '1.8'
    }

    sourceSets {
        main.java.srcDirs += 'src/main/kotlin'
    }

    defaultConfig {
        applicationId "com.voxfuture.app"
        minSdkVersion 21
        targetSdkVersion 34
        versionCode 1
        versionName "1.0.0"
    }

    buildTypes {
        release {
            signingConfig signingConfigs.debug
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
}

flutter {
    source '../..'
}

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
}
EOF

# Atualizar AndroidManifest.xml
mkdir -p android/app/src/main
cat > android/app/src/main/AndroidManifest.xml << 'EOF'
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-permission android:name="android.permission.INTERNET"/>
    <uses-permission android:name="android.permission.RECORD_AUDIO"/>
    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    
    <application
        android:label="VOXFUTURE"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher"
        android:allowBackup="false"
        android:usesCleartextTraffic="true">
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            
            <meta-data
                android:name="io.flutter.embedding.android.NormalTheme"
                android:resource="@style/NormalTheme"/>
            
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        
        <meta-data
            android:name="flutterEmbedding"
            android:value="2"/>
    </application>
</manifest>
EOF

# 4. CONFIGURAR iOS
echo -e "${YELLOW}ðŸŽ Configurando iOS...${NC}"

# Atualizar Info.plist
cat > ios/Runner/Info.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleDevelopmentRegion</key>
    <string>$(DEVELOPMENT_LANGUAGE)</string>
    <key>CFBundleDisplayName</key>
    <string>VOXFUTURE</string>
    <key>CFBundleExecutable</key>
    <string>$(EXECUTABLE_NAME)</string>
    <key>CFBundleIdentifier</key>
    <string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
    <key>CFBundleInfoDictionaryVersion</key>
    <string>6.0</string>
    <key>CFBundleName</key>
    <string>VOXFUTURE</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0.0</string>
    <key>CFBundleSignature</key>
    <string>????</string>
    <key>CFBundleVersion</key>
    <string>1</string>
    <key>LSRequiresIPhoneOS</key>
    <true/>
    
    <key>NSMicrophoneUsageDescription</key>
    <string>VOXFUTURE precisa acessar o microfone para gravar e analisar sua voz</string>
    
    <key>UILaunchStoryboardName</key>
    <string>LaunchScreen</string>
    <key>UIMainStoryboardFile</key>
    <string>Main</string>
    <key>UIRequiredDeviceCapabilities</key>
    <array>
        <string>armv7</string>
    </array>
    <key>UISupportedInterfaceOrientations</key>
    <array>
        <string>UIInterfaceOrientationPortrait</string>
        <string>UIInterfaceOrientationLandscapeLeft</string>
        <string>UIInterfaceOrientationLandscapeRight</string>
    </array>
    <key>UISupportedInterfaceOrientations~ipad</key>
    <array>
        <string>UIInterfaceOrientationPortrait</string>
        <string>UIInterfaceOrientationPortraitUpsideDown</string>
        <string>UIInterfaceOrientationLandscapeLeft</string>
        <string>UIInterfaceOrientationLandscapeRight</string>
    </array>
    <key>UIViewControllerBasedStatusBarAppearance</key>
    <false/>
</dict>
</plist>
EOF

# 5. CRIAR ARQUIVOS DE CONFIGURAÃ‡ÃƒO CODEMAGIC
echo -e "${YELLOW}âš™ï¸ Configurando CodeMagic...${NC}"

# ConfiguraÃ§Ã£o principal CodeMagic
cat > codemagic.yaml << 'EOF'
workflows:
  voxfuture-android:
    name: VOXFUTURE Android Build
    environment:
      groups:
        - google_play_credentials
      vars:
        PACKAGE_NAME: "com.voxfuture.app"
    scripts:
      - name: Verify Flutter Structure
        script: |
          echo "ðŸ” Verificando estrutura..."
          ls -la
          [ -d "android" ] && echo "âœ… Android OK" || echo "âŒ Android missing"
          [ -d "ios" ] && echo "âœ… iOS OK" || echo "âŒ iOS missing"
      - name: Set up Flutter
        script: |
          flutter --version
          flutter pub get
      - name: Build Android AAB
        script: |
          flutter build appbundle --release
        artifacts:
          - build/app/outputs/bundle/release/app-release.aab
      - name: Build Android APK
        script: |
          flutter build apk --release --split-per-abi
        artifacts:
          - build/app/outputs/apk/release/app-armeabi-v7a-release.apk
          - build/app/outputs/apk/release/app-arm64-v8a-release.apk
          - build/app/outputs/apk/release/app-x86_64-release.apk

  voxfuture-ios:
    name: VOXFUTURE iOS Build
    environment:
      groups:
        - app_store_credentials
      vars:
        BUNDLE_ID: "com.voxfuture.app"
    scripts:
      - name: Set up Flutter
        script: |
          flutter --version
          flutter pub get
      - name: Install iOS dependencies
        script: |
          cd ios
          pod install
      - name: Build iOS IPA
        script: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
                    -scheme Runner \
                    -configuration Release \
                    -archivePath build/Products/Runner.xcarchive \
                    archive
          xcodebuild -exportArchive \
                    -archivePath build/Products/Runner.xcarchive \
                    -exportPath build/Products/IPA \
                    -exportOptionsPlist ExportOptions.plist
        artifacts:
          - ios/build/Products/IPA/Runner.ipa
EOF

# ConfiguraÃ§Ã£o iOS para CodeMagic
cat > ios/ExportOptions.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>development</string>
    <key>teamID</key>
    <string>YOUR_TEAM_ID</string>
    <key>uploadBitcode</key>
    <false/>
    <key>compileBitcode</key>
    <false/>
</dict>
</plist>
EOF

# 6. CRIAR SCRIPT DE VERIFICAÃ‡ÃƒO
cat > scripts/verify_build_setup.sh << 'EOF'
#!/bin/bash

echo "ðŸ” VERIFICAÃ‡ÃƒO DA CONFIGURAÃ‡ÃƒO DE BUILD"

# Cores
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

check_file() {
    if [ -f "$1" ]; then
        echo -e "${GREEN}âœ… $1${NC}"
        return 0
    else
        echo -e "${RED}âŒ $1 (FALTANDO)${NC}"
        return 1
    fi
}

check_dir() {
    if [ -d "$1" ]; then
        echo -e "${GREEN}âœ… $1${NC}"
        return 0
    else
        echo -e "${RED}âŒ $1 (FALTANDO)${NC}"
        return 1
    fi
}

echo ""
echo "ðŸ“ ESTRUTURA DO PROJETO:"
check_dir "android"
check_dir "ios"
check_dir "lib"

echo ""
echo "ðŸ“„ ARQUIVOS ESSENCIAIS:"
check_file "pubspec.yaml"
check_file "lib/main.dart"

echo ""
echo "ðŸ¤– CONFIGURAÃ‡ÃƒO ANDROID:"
check_file "android/app/build.gradle"
check_file "android/app/src/main/AndroidManifest.xml"
check_dir "android/app/src/main/res"

echo ""
echo "ðŸŽ CONFIGURAÃ‡ÃƒO iOS:"
check_file "ios/Runner/Info.plist"
check_file "ios/Runner.xcworkspace"
check_file "ios/ExportOptions.plist"

echo ""
echo "âš™ï¸ CONFIGURAÃ‡ÃƒO CODEMAGIC:"
check_file "codemagic.yaml"

echo ""
echo "ðŸŽ¯ STATUS:"
if [ -d "android" ] && [ -d "ios" ] && [ -f "pubspec.yaml" ]; then
    echo -e "${GREEN}ðŸš€ PRONTO PARA BUILD NO CODEMAGIC!${NC}"
else
    echo -e "${RED}âŒ CONFIGURAÃ‡ÃƒO INCOMPLETA${NC}"
    echo "Execute: ./scripts/setup/complete_flutter_setup.sh"
fi
EOF

chmod +x scripts/verify_build_setup.sh

echo -e "${GREEN}ðŸŽ‰ CONFIGURAÃ‡ÃƒO COMPLETA CONCLUÃDA!${NC}"
echo ""
echo -e "${YELLOW}ðŸ“‹ PRÃ“XIMOS PASSOS:${NC}"
echo "1. Execute: chmod +x scripts/setup/complete_flutter_setup.sh"
echo "2. Execute: ./scripts/setup/complete_flutter_setup.sh"
echo "3. Execute: ./scripts/verify_build_setup.sh"
echo "4. FaÃ§a commit: git add . && git commit -m 'feat: add complete build structure'"
echo "5. Push: git push origin main"
echo ""
echo -e "${GREEN}ðŸš€ Depois disso, o CodeMagic deve construir AAB e IPA com sucesso!${NC}"
